{% extends 'configmanager/__base__.html' %}
{% block title %}修改配置 | {% endblock %}
{% block content %}
<h2>配置管理 > 修改配置</h2>
{% if site_list %}
<table border="1">
    <th>站点名称</th>
    <th>发布注意事项</th>
    <th>配置文件</th>
    <th>所属ECS 配置状态 操作</th>
    <th>所属ECS SLB状态 健康状态 操作</th>
    <th>健康检查</th>
    <th>配置修改人</th>
    <th>修改日期</th>
    {% for site in site_list %}
    <tr>
        <td>
            <a href="{% url 'configmanager:sitechange' site.id %}" target="_blank">{{ site.fullname }}</a>
        </td>
        <td>{{ site.deployattention }}</td>
        <td align="right">
            {% for configfile in site.configfile_set.all %}
                <p>
                    {{ configfile.filename }}&nbsp;
                    <a href="{% url 'configmanager:configchange' configfile.id %}">修改</a>&nbsp;
                    <a href="{% url 'configmanager:confighistory' configfile.id %}">历史记录</a>&nbsp;
                </p>
            {% endfor %}
        </td>
        <td align="right">
            {% for r in site.release_set.all %}
                {% if r.ECS.name in site.get_ECSlists_list %}
                <p>
                    {{ r.ECS }}&nbsp;
                    {% if r.status == "N" %}
                        <font color="red">待生效</font>&nbsp;<a href="{% url 'configmanager:configdeploy' r.id %}" >发布</a>&nbsp;
                    {% endif %}
                    {% if r.status == "Y" %}
                        已生效&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    {% endif %}
                </p>
                {% endif %}
            {% endfor %}
        </td>
        <td align="right">
            {% for ecs in site.get_one_slb.slbhealthstatus_set.all %}
                <p>
                    <span>{{ ecs.ECS }}</span>&nbsp;&nbsp;&nbsp;&nbsp;
                    <span>{% if ecs.SLBstatus == "added" %}已添加{% else %}<font color="red">已移除</font>{% endif %}</span>&nbsp;&nbsp;&nbsp;&nbsp;
                    <span>
                        {% if ecs.SLBstatus == "added" %}
                            {% if ecs.healthstatus == "normal" %}正常&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            {% elif ecs.healthstatus == "abnormal" %}<font color="red">异常</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            {% else %}<font color="red">正在检查</font>&nbsp;
                            {% endif %}
                        {% else %}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        {% endif %}
                    </span>&nbsp;&nbsp;&nbsp;&nbsp;
                    <span>
                        {% if ecs.SLBstatus == "added" %}<a href="{% url 'configmanager:removebackendserver' slb_id=site.get_one_slb.id server_id=ecs.ECS_id %}">移除</a>{% endif %}
                        {% if ecs.SLBstatus == "removed" %}<a href="{% url 'configmanager:addbackendserver' slb_id=site.get_one_slb.id server_id=ecs.ECS_id %}">添加</a>{% endif %}
                    </span>
                <p/>
            {% endfor %}
        </td>
        <td><a href="{% url 'configmanager:slbhealthupdate' site.get_one_slb_id %}">刷新</a></td>
        <td>
            {% for config in site.configfile_set.all %} 
                <p>{{ config.modified_user }}</p>
            {% endfor %}
        </td>
        <td>
            {% for config in site.configfile_set.all %} 
                <p>{{ config.modified_time }}</p>
            {% endfor %}
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
    <p>No ECS are available.</p>
{% endif %}
{% endblock %}
