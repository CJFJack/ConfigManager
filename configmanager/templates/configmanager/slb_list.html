{% extends 'configmanager/__base__.html' %}
{% block title %}SLB列表 | {% endblock %}
{% block content %}




<div id="bgDiv"></div>
<div id="myspin">
<h2>SLB管理 > SLB列表</h2>
    <ul class="object-tools">
    <li>
        <a href="javascript:void(0);" onclick="AllSLBinfoUpdate()"  class="link">同步SLB基本信息</a>
    </li>
    <li>
        <a href="javascript:void(0);" onclick="AllSLBHealthUpdate()" class="link">刷新所有SLB健康信息</a>
    </li>
</ul>
{% if slb_list %}
    <table border="1">
    <th align="right">ECS名称&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SLB状态&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;健康状态&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;操作</th>
    <th>健康状态</th>
    <th>实例ID</th>
    <th>实例别名</th>
    <th>实例状态</th>
    <th>实例IP</th>
    <th>IP地址类型</th>
    <th>网络类型</th>
    <th>创建时间</th>
    <th>站点列表</th>
    {% for slb in slb_list %}
    <tr>
        <td align="right" id="td_{{ slb.id }}">
            {% for ecs in slb.slbhealthstatus_set.all %}
                <span>{{ ecs.ECS }}</span>&nbsp;&nbsp;&nbsp;&nbsp;
                <span>{% if ecs.SLBstatus == "added" %}已添加{% else %}<font color="red">已移除</font>{% endif %}</span>&nbsp;&nbsp;&nbsp;&nbsp;
                {% if ecs.SLBstatus == "added" %}
                    {% if ecs.healthstatus == "normal" %}<span>正常</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    {% elif ecs.healthstatus == "abnormal" %}<span><font color="red">异常</font></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    {% else %}<span><font color="red">正在检查</font></span>&nbsp;
                    {% endif %}
                {% else %}
                    <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                {% endif %}
                <span>
                    {% if ecs.SLBstatus == "added" %}<a href="javascript:void(0);" id="removebackendserver{{ slb.id }}" onclick="RemoveBackendServer({{ slb.id }},{{ ecs.ECS_id }})">移除</a>{% endif %}
                    {% if ecs.SLBstatus == "removed" %}<a href="javascript:void(0);" id="addbackendserver{{ slb.id }}" onclick="AddBackendServer({{ slb.id }},{{ ecs.ECS_id }})">添加</a>{% endif %}
                </span><br/>
            {% endfor %}
        </td>
        <p style="display:none" id="{{ slb.id }}">{{ slb.id }}</p>
        <td><a href="javascript:void(0);" id="healthrefresh{{ slb.id }}" onclick="HealthRefresh({{ slb.id }})">刷新</a></td>
        <td><a href="{% url 'configmanager:slbdetail' slb.id %}">{{ slb.instanceid }}</td>
        <td>{{ slb.name }}</td>
        <td>{{ slb.status }}</td>
        <td>{{ slb.ip }}</td>
        <td>{% if slb.addresstype == "internet" %}公网{% endif %}{% if slb.addresstype == "intranet" %}私网{% endif %}</td>
        <td>{% if slb.networktype == "classic" %}经典网络{% endif %}{% if slb.networktype == "vpc" %}专有网络{% endif %}</td>
        <td>{{ slb.createdate }}</td>
        <td>
            {% for site in slb.slbsite_set.all %}
                <p>{{ site }}</p>
            {% endfor %}
        </td>
    </tr>
    {% endfor %}
    </table>
{% else %}
    <p>No SLB are available.</p>
{% endif %}
</div>



<script>
$.ajaxSetup({
    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
});

//局部刷新
function PartialRefresh(slbid) {
    var postUrl = "/slb/"+slbid+"/partrefresh/"
    $.post(postUrl, function(data) {
        $('#td_'+slbid).html(data)
    });
}


//刷新SLB健康状态
function HealthRefresh(slbid) {
    var postUrl = "/slb/"+slbid+"/slbhealthupdate/";

    target = $("#myspin").get(0);                                                                                 
    var bgDiv = document.getElementById("bgDiv");                                                                 
    bgDiv.style.display = "block";                                                                                
    spinner.spin(target);  

    $.post(postUrl, function (data) {
        if (data.success) {
            PartialRefresh(slbid);
        } else {
            alert("操作失败！"+data.message);
        }
        setTimeout(function () {
            spinner.spin();                                                                                           
            bgDiv.style.display = "none";  
        },800);
    });
}


//移除SLB后端服务器
function RemoveBackendServer(slbid, serverid) {
    var postUrl = "/slb/"+slbid+"/removebackendserver/"+serverid+"/";

    target = $("#myspin").get(0);                                                                                 
    var bgDiv = document.getElementById("bgDiv");                                                                 
    bgDiv.style.display = "block";                                                                                
    spinner.spin(target);  

    $.post(postUrl, function (data) {
        if (data.success) {
            PartialRefresh(slbid)
        } else {
            alert("操作失败！"+data.message);
        }
        setTimeout(function () {
            spinner.spin();                                                                                           
            bgDiv.style.display = "none";  
        },300);
    });
}


//添加SLb后端服务器
function AddBackendServer(slbid, serverid) {                                                                                           
    var postUrl = "/slb/"+slbid+"/addbackendserver/"+serverid+"/";                                                                     
                                                                                                                                          
    target = $("#myspin").get(0);                                                                                                         
    var bgDiv = document.getElementById("bgDiv");                                                                                         
    bgDiv.style.display = "block";                                                                                                        
    spinner.spin(target);                                                                                                                 
                                                                                                                                          
    $.post(postUrl, function (data) {                                                                                                     
        if (data.success) {                                                                                                               
            PartialRefresh(slbid)
        } else {                                                                                                                          
            alert("操作失败！"+data.message);                                                                                             
        }                                                                                                                                 
        setTimeout(function () {                                                                                                          
            spinner.spin();                                                                                                               
            bgDiv.style.display = "none";                                                                                                 
        },300);                                                                                                                          
    });                                                                                                                                   
} 


//同步SLB基本信息
function AllSLBinfoUpdate() {                                                                                           
    var postUrl = "/slb/allinfoupdate/";
                                                                                                                                          
    target = $("#myspin").get(0);                                                                                                         
    var bgDiv = document.getElementById("bgDiv");                                                                                         
    bgDiv.style.display = "block";                                                                                                        
    spinner.spin(target);                                                                                                                 
                                                                                                                                          
    $.post(postUrl, function (data) {                                                                                                     
        if (data.success) {                                                                                                               
            alert("操作i成功！");
            window.location.href="/slb/"
        } else {                                                                                                                          
            alert("操作失败！"+data.message);                                                                                             
        }                                                                                                                                 
        setTimeout(function () {                                                                                                          
            spinner.spin();                                                                                                               
            bgDiv.style.display = "none";                                                                                                 
        },300);                                                                                                                          
    });                                                                                                                                   
}


//刷新所有SLB健康信息
function AllSLBHealthUpdate() {                                                                                           
    var postUrl = "/slb/allslbhealthupdate/";
                                                                                                                                          
    target = $("#myspin").get(0);                                                                                                         
    var bgDiv = document.getElementById("bgDiv");                                                                                         
    bgDiv.style.display = "block";                                                                                                        
    spinner.spin(target);                                                                                                                 
                                                                                                                                          
    $.post(postUrl, function (data) {                                                                                                     
        if (data.success) {                                                                                                               
            alert("操作i成功！");
            window.location.href="/slb/"
        } else {                                                                                                                          
            alert("操作失败！"+data.message);                                                                                             
        }                                                                                                                                 
        setTimeout(function () {                                                                                                          
            spinner.spin();                                                                                                               
            bgDiv.style.display = "none";                                                                                                 
        },300);                                                                                                                          
    });                                                                                                                                   
}



</script>



{% endblock %}
